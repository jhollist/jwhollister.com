<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  

  <link rel="icon" type="image/png" href="/favicon.png">

  <title>
    
    
     Download Shapefiles - Take 2 
    
  </title>
  <link rel="canonical" href="/post/2015-06-15-download-shapefile-reprise/">

  <link rel="stylesheet" href="/css/fonts.css" />
  <link rel="stylesheet" href="/css/style.css" />
  
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

  
</head>

<body>
<section id=nav>
  <ul id=social>
    
    <li><a href= "https://twitter.com/jhollist"><i class='fab fa-twitter'></i></a></li>
    
    
    <li><a href= "https://github.com/jhollist"><i class='fab fa-github'></i></a></li>
    
    
    <li><a href= "https://scholar.google.com/citations?user=Fn9BjfIAAAAJ"><i class='fas fa-graduation-cap'></i></a></li>
    
  </ul>
  <h1><a href="/">Jeffrey W. Hollister</a></h1>
  <ul>
    
    
    <li><a href="/"><i class='fas fa-home'></i><br>Home</a></li>
    
    
    
    <li><a href="/about/"><i class='fas fa-question'></i><br>About</a></li>
    
    
    
    <li><a href="/talks/"><i class='fas fa-chalkboard'></i><br>Talks</a></li>
    
    
    
    <li><a href="/cv/"><i class='fas fa-book-open'></i><br>Vitae</a></li>
    
    
  </ul>
</section>



<section id=content>

  <h1> Download Shapefiles - Take 2 </h1>
  
  
  <div id=sub-header>
     · 2015-06-15 · 2 minute read
  </div>
  

  <div class="entry-content">
    <p>So back in 2013 I <a href="https://landeco2point0.wordpress.com/2013/09/30/an-r-function-to-download-shapefiles/">posted a little function</a> I wrote for grabbing all the relevant files that make up a shapefile from a URL.  Turns out it doesn&rsquo;t play so well with Windows 7 or Windows 8 (HT: John Lewis).  Below is a reprised version that at least works on Ubuntu 14.04 and Windows 7.  Haven&rsquo;t tested it beyond that and supressing the warnings to get <code>httr::GET</code> to not complain too much about FTP seems a bit unclean.  Well, you get what you pay for.</p>

<p>For all this to run you&rsquo;ll need <code>RCurl</code>, <code>httr</code>, <code>sp</code>, and <code>rgdal</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">download_shp&lt;-<span style="color:#00f">function</span> (shape_url, layer, outfolder = <span style="color:#a31515">&#34;.&#34;</span>) 
{
  <span style="color:#00f">if</span> (<span style="color:#00f">length</span>(<span style="color:#00f">grep</span>(<span style="color:#a31515">&#34;/$&#34;</span>, shape_url)) == 0) {
    shape_url &lt;- <span style="color:#00f">paste</span>(shape_url, <span style="color:#a31515">&#34;/&#34;</span>, sep = <span style="color:#a31515">&#34;&#34;</span>)
  }
  
  shapefile_ext &lt;- <span style="color:#2b91af">c</span>(<span style="color:#a31515">&#34;.shp&#34;</span>, <span style="color:#a31515">&#34;.shx&#34;</span>, <span style="color:#a31515">&#34;.dbf&#34;</span>, <span style="color:#a31515">&#34;.prj&#34;</span>, <span style="color:#a31515">&#34;.sbn&#34;</span>, 
                     <span style="color:#a31515">&#34;.sbx&#34;</span>, <span style="color:#a31515">&#34;.shp.xml&#34;</span>, <span style="color:#a31515">&#34;.fbn&#34;</span>, <span style="color:#a31515">&#34;.fbx&#34;</span>, <span style="color:#a31515">&#34;.ain&#34;</span>, <span style="color:#a31515">&#34;.aih&#34;</span>, <span style="color:#a31515">&#34;.ixs&#34;</span>, 
                     <span style="color:#a31515">&#34;.mxs&#34;</span>, <span style="color:#a31515">&#34;.atx&#34;</span>, <span style="color:#a31515">&#34;.cpg&#34;</span>)

  xlogic &lt;- <span style="color:#00f">NULL</span>
  <span style="color:#00f">if</span>(<span style="color:#00f">substr</span>(shape_url,1,3)==<span style="color:#a31515">&#34;ftp&#34;</span>){
    xurl &lt;- RCurl::getURL(shape_url)
    <span style="color:#00f">for</span> (i <span style="color:#00f">in</span> <span style="color:#00f">paste</span>(layer, shapefile_ext, sep = <span style="color:#a31515">&#34;&#34;</span>)) {
      xlogic &lt;- <span style="color:#2b91af">c</span>(xlogic, <span style="color:#00f">grepl</span>(i, xurl))
    }
  } <span style="color:#00f">else</span> <span style="color:#00f">if</span>(<span style="color:#00f">substr</span>(shape_url,1,4)==<span style="color:#a31515">&#34;http&#34;</span>){
    <span style="color:#00f">for</span> (i <span style="color:#00f">in</span> <span style="color:#00f">paste</span>(shape_url,layer, shapefile_ext, sep = <span style="color:#a31515">&#34;&#34;</span>)) {
      xlogic &lt;- <span style="color:#2b91af">c</span>(xlogic,httr::HEAD(i)$status==200)
    }  
  }
  
 
  shapefiles &lt;- <span style="color:#00f">paste</span>(shape_url, layer, shapefile_ext, 
                      sep = <span style="color:#a31515">&#34;&#34;</span>)[xlogic]
  outfiles &lt;- <span style="color:#00f">paste</span>(outfolder, <span style="color:#a31515">&#34;/&#34;</span>, layer, shapefile_ext, 
                    sep = <span style="color:#a31515">&#34;&#34;</span>)[xlogic]
  
  <span style="color:#00f">if</span> (<span style="color:#00f">sum</span>(xlogic) &gt; 0) {
    <span style="color:#00f">for</span> (i <span style="color:#00f">in</span> 1:<span style="color:#00f">length</span>(shapefiles)) {
      x &lt;- <span style="color:#00f">suppressWarnings</span>(httr::GET(shapefiles[i], 
                                      httr::write_disk(outfiles[i],
                                                       overwrite = <span style="color:#00f">TRUE</span>)))
      
      dwnld_file &lt;- <span style="color:#00f">strsplit</span>(shapefiles[i], <span style="color:#a31515">&#34;/&#34;</span>)[[1]]
      dwnld_file &lt;- dwnld_file[<span style="color:#00f">length</span>(dwnld_file)]
      
      <span style="color:#00f">print</span>(<span style="color:#00f">paste0</span>(<span style="color:#a31515">&#34;Downloaded &#34;</span>, dwnld_file, <span style="color:#a31515">&#34; to &#34;</span>, 
                   outfiles[i], <span style="color:#a31515">&#34;.&#34;</span>))
    }
  }
  <span style="color:#00f">else</span> {
    <span style="color:#00f">stop</span>(<span style="color:#a31515">&#34;An Error has occured with the input URL or 
</span><span style="color:#a31515">              name of shapefile&#34;</span>)
  }
}</code></pre></div>
<p>And to see that it works again:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#008000">#Download the NH State Boundaries</span>
download_shp(<span style="color:#a31515">&#34;ftp://ftp.granit.sr.unh.edu/pub/GRANIT_Data/Vector_Data/Administrative_and_Political_Boundaries/d-nhsenatedists/2012&#34;</span>,
                   <span style="color:#a31515">&#34;NHSenateDists2012&#34;</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.shp to ./NHSenateDists2012.shp.&#34;</span>
<span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.shx to ./NHSenateDists2012.shx.&#34;</span>
<span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.dbf to ./NHSenateDists2012.dbf.&#34;</span>
<span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.prj to ./NHSenateDists2012.prj.&#34;</span>
<span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.sbn to ./NHSenateDists2012.sbn.&#34;</span>
<span style="color:#008000">## [1] &#34;Downloaded NHSenateDists2012.sbx to ./NHSenateDists2012.sbx.&#34;</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#008000">#Read shapefiles in SpatialPolygonsDataFrame</span>
NHBnd&lt;-readOGR(<span style="color:#a31515">&#34;.&#34;</span>,<span style="color:#a31515">&#34;NHSenateDists2012&#34;</span>)</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#008000">## OGR data source with driver: ESRI Shapefile </span>
<span style="color:#008000">## Source: &#34;.&#34;, layer: &#34;NHSenateDists2012&#34;</span>
<span style="color:#008000">## with 24 features</span></code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#008000">#Plot it</span>
plot(NHBnd)</code></pre></div>
<p><img src="/figure/run_it-1.png" alt="plot of chunk run_it" /></p>

  </div>

  <div id=links>
    
      <a class="basic-alignment left" href="/post/2015-03-13-quickmapr-pre-release/">&laquo; quickmapr: An R package for mapping and interacting with spatial data</a>
    
    
      <a class="basic-alignment left" href="/post/2015-10-30-i-finally-got-quickmapr-up-on-cran/">I finally got quickmapr on CRAN! &raquo;</a>
    
  </div>
</section>


<section id="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
      
      
      if (window.location.hostname == "localhost")
                return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'jeffreywhollister';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-43969710-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>

